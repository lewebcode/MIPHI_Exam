version: '3.9'

services:
  # Eureka Server для service discovery
  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    container_name: eureka-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_APPLICATION_NAME=eureka-server
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false
      - EUREKA_SERVER_ENABLE_SELF_PRESERVATION=false
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=eureka-server
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/eureka/apps"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # Hotel Management Service
  hotel-service:
    build:
      context: .
      dockerfile: hotel-service/Dockerfile
    container_name: hotel-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_APPLICATION_NAME=hotel-service
      - SERVER_PORT=8081
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - SPRING_DATASOURCE_URL=jdbc:h2:mem:hoteldb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=false
      - SPRING_DATASOURCE_DRIVERCLASSNAME=org.h2.Driver
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_H2_CONSOLE_ENABLED=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=hotel-service
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=true
      - EUREKA_CLIENT_FETCH_REGISTRY=true
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_RU_MIFI=DEBUG
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # Booking Service
  booking-service:
    build:
      context: .
      dockerfile: booking-service/Dockerfile
    container_name: booking-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_APPLICATION_NAME=booking-service
      - SERVER_PORT=8082
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - SPRING_DATASOURCE_URL=jdbc:h2:mem:bookingdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=false
      - SPRING_DATASOURCE_DRIVERCLASSNAME=org.h2.Driver
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_H2_CONSOLE_ENABLED=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=booking-service
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=true
      - EUREKA_CLIENT_FETCH_REGISTRY=true
      - HOTEL_SERVICE_URL=http://hotel-service:8081/api
      - JWT_SECRET=your-secret-key-change-this-in-production-environment
      - JWT_EXPIRATION=3600000
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_RU_MIFI=DEBUG
    depends_on:
      eureka-server:
        condition: service_healthy
      hotel-service:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - SERVER_PORT=8080
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=api-gateway
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=true
      - EUREKA_CLIENT_FETCH_REGISTRY=true
      - SPRING_CLOUD_GATEWAY_ROUTES_0_ID=booking-service
      - SPRING_CLOUD_GATEWAY_ROUTES_0_URI=lb://booking-service
      - SPRING_CLOUD_GATEWAY_ROUTES_0_PREDICATES_0=Path=/api/bookings/**,/api/users/**,/api/user/**
      - SPRING_CLOUD_GATEWAY_ROUTES_1_ID=hotel-service
      - SPRING_CLOUD_GATEWAY_ROUTES_1_URI=lb://hotel-service
      - SPRING_CLOUD_GATEWAY_ROUTES_1_PREDICATES_0=Path=/api/hotels/**,/api/rooms/**
      - JWT_SECRET=your-secret-key-change-this-in-production-environment
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_RU_MIFI=DEBUG
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD=DEBUG
    depends_on:
      eureka-server:
        condition: service_healthy
      hotel-service:
        condition: service_healthy
      booking-service:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

networks:
  microservices-network:
    driver: bridge

volumes:
  eureka-data:
    driver: local
